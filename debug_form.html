<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Volunteer Form</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        body { background: #f7f7fb; padding: 20px; }
        .card { border-radius: 1rem; margin-bottom: 20px; }
        .debug-info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="mb-3">Debug Volunteer Form</h3>
                        
                        <div class="debug-info">
                            <strong>Debug Info:</strong> This form will log all data to console and show detailed error messages.
                        </div>
                        
                        <form id="volForm" class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Full Name *</label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Mobile *</label>
                                <input type="tel" name="mobile" class="form-control" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Village</label>
                                <div class="input-group">
                                    <select id="village_id" name="village_id" class="form-select">
                                        <option value="">-- Select Village --</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" id="btnAddVillage">+ Add New</button>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">City</label>
                                <input type="text" name="city" class="form-control">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">State</label>
                                <input type="text" name="state" class="form-control">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Country</label>
                                <input type="text" name="country" class="form-control" value="India">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" name="email" class="form-control">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Phone (Alt)</label>
                                <input type="tel" name="phone" class="form-control">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" name="dob" class="form-control">
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">Remarks</label>
                                <textarea name="remarks" class="form-control" rows="3"></textarea>
                            </div>
                            
                            <div class="col-12">
                                <button class="btn btn-primary" type="submit">Submit Form</button>
                                <button class="btn btn-secondary" type="button" id="btnTestAPI">Test API</button>
                            </div>
                        </form>
                        
                        <div id="debugOutput" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function log(message, data = null) {
            console.log(message, data);
            const output = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div class="alert alert-info">[${timestamp}] ${message}</div>`;
        }

        function showError(message) {
            const output = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div class="alert alert-danger">[${timestamp}] ERROR: ${message}</div>`;
        }

        function showSuccess(message) {
            const output = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div class="alert alert-success">[${timestamp}] SUCCESS: ${message}</div>`;
        }

        // Load villages
        async function loadVillages() {
            try {
                log('Loading villages...');
                const res = await fetch('api/villages.php?fn=list');
                log('Villages API response status:', res.status);
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                log('Villages data received:', data);
                
                const sel = document.getElementById('village_id');
                sel.innerHTML = '<option value="">-- Select Village --</option>';
                data.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.id;
                    opt.textContent = v.village_name;
                    sel.appendChild(opt);
                });
                
                showSuccess(`Loaded ${data.length} villages`);
            } catch (error) {
                showError('Failed to load villages: ' + error.message);
                console.error('Villages error:', error);
            }
        }

        // Test API endpoint
        async function testAPI() {
            try {
                log('Testing volunteers API...');
                const res = await fetch('api/volunteers.php?fn=list');
                log('API response status:', res.status);
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                log('API test successful, received data:', data);
                showSuccess('API test successful');
            } catch (error) {
                showError('API test failed: ' + error.message);
                console.error('API test error:', error);
            }
        }

        // Form submission
        document.getElementById('volForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            log('Form submitted');
            
            try {
                const form = e.target;
                const formData = new FormData(form);
                formData.append('fn', 'add');
                
                // Log form data
                log('Form data being sent:');
                for (let [key, value] of formData.entries()) {
                    log(`  ${key}: ${value}`);
                }
                
                log('Sending to API...');
                const res = await fetch('api/volunteers.php', { 
                    method: 'POST', 
                    body: formData 
                });
                
                log('API response status:', res.status);
                log('API response headers:', Object.fromEntries(res.headers.entries()));
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                log('API response data:', data);
                
                if (data.ok) {
                    showSuccess(`Volunteer saved successfully! ID: ${data.id}`);
                    form.reset();
                    document.querySelector('input[name=country]').value = 'India';
                } else {
                    showError('API returned error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Form submission failed: ' + error.message);
                console.error('Form submission error:', error);
            }
        });

        // Event listeners
        document.getElementById('btnTestAPI').addEventListener('click', testAPI);
        document.getElementById('btnAddVillage').addEventListener('click', () => {
            const name = prompt('Enter village name:');
            if (name) {
                log('Adding village:', name);
                // Add village logic here
            }
        });

        // Load initial data
        log('Page loaded, initializing...');
        loadVillages();
    </script>
</body>
</html>

